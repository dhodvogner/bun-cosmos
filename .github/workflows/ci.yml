name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun test

      - name: Check TypeScript types
        run: bun --bun tsc --noEmit

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check formatting
        run: |
          echo "Formatting check would go here"
          # Could add prettier or other linting tools

  build:
    name: Build Example
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Generate stub cosmos.imports for build test
        run: |
          # Create a minimal stub file for CI build testing
          # In real usage, React Cosmos generates this automatically
          cat > cosmos.imports.ts << 'EOF'
          import type { RendererConfig, UserModuleWrappers } from 'react-cosmos-core';
          
          export const rendererConfig: RendererConfig = {
            "webSocketUrl": "ws://localhost:5000",
            "rendererUrl": "http://localhost:3008/cosmos.html"
          };
          
          const fixtures = {};
          const decorators = {};
          
          export const moduleWrappers: UserModuleWrappers = {
            lazy: false,
            fixtures,
            decorators
          };
          EOF

      - name: Build renderer
        run: |
          # Test that the build process works
          bun build cosmos/cosmos.renderer.tsx --outdir ./cosmos/out --sourcemap=external

      - name: Verify build artifacts
        run: |
          test -f cosmos/out/cosmos.renderer.js || exit 1
          echo "Build artifacts verified!"
